# Step: STEP 8 - PACKAGE & EXPORT

## Purpose

Finalize template, create ZIP package, and show success message.

---

## What To Do

### 0. Initialize Step Variables

```bash
# Load common variables (helpers already loaded by SKILL.md)
init_step
# Now: SLUG, NAME, DESCRIPTION, TIMESTAMP are available
```

---

### 1. Update metadata.json with Final Counts

```bash
# Get counts from state
eval $(jq -r '.summary | @sh "LISTS=\(.lists) DOCS=\(.documents) FILES=\(.files) AUTOS=\(.automations) AGENTS=\(.chatAgents) WS=\(.claudeWorkspaces)"' .template-generator-state.json)

jq --argjson lists ${LISTS} \
   --argjson docs ${DOCS} \
   --argjson files ${FILES} \
   --argjson autos ${AUTOS} \
   --argjson agents ${AGENTS} \
   --argjson ws ${WS} \
   '.exports = {
     "lists": $lists,
     "documents": $docs,
     "files": $files,
     "automations": $autos,
     "chatAgents": $agents,
     "claudeWorkspaces": $ws
   }' \
   template-${SLUG}/metadata.json > .tmp && mv .tmp template-${SLUG}/metadata.json
```

---

### 2. Create IMPORT.md

```bash
eval $(jq -r '@sh "NAME=\(.name) DESC=\(.description)"' template-${SLUG}/metadata.json)

cat > template-${SLUG}/IMPORT.md << EOF
# ${NAME} - Import Instructions

## Overview

${DESC}

## What's Included

- ${LISTS} Lists
- ${DOCS} Documents
- ${FILES} Files
- ${AUTOS} Automations
- ${AGENTS} Chat Agents
- ${WS} AI Workspaces

## Import Steps

1. Extract this ZIP file
2. Use the import function in your app
3. Select this template folder
4. Confirm import

## Requirements

- Minimum app version: 1.0.0
- Required features: (list if any)

---

Generated by AI Template Generator
Version: 1.0.0
Created: $(date -u +%Y-%m-%d)
EOF
```

---

### 3. Create ZIP Package

```bash
cd template-${SLUG}/
zip -r ../${SLUG}-template.zip .
cd ..
```

---

### 4. Upload to Cloud Server

```bash
ZIP_FILE="${SLUG}-template.zip"

# Get upload URL from environment or use default
CLOUD_UPLOAD_URL=$(get_upload_url)

# Upload to cloud server and get URL
UPLOAD_RESPONSE=$(curl -s -X POST \
  -F "file=@${ZIP_FILE}" \
  "${CLOUD_UPLOAD_URL}")

# Extract URL from JSON response
DOWNLOAD_URL=$(echo ${UPLOAD_RESPONSE} | jq -r '.url')

if [[ "${DOWNLOAD_URL}" != "null" && -n "${DOWNLOAD_URL}" ]]; then
  echo "âœ… Upload successful! Cloud URL: ${DOWNLOAD_URL}"
else
  # Exit with error - don't continue
  echo "âŒ Error: Failed to upload template to server"
  echo "Server response: ${UPLOAD_RESPONSE}"
  echo ""
  echo "Would you like me to try again? (say 'retry' to attempt upload again)"
  exit 1
fi
```

**NOTE:** If user says "retry", go back to step 4 and attempt the upload again without recreating the ZIP file.

---

### 5. Clean Up Temporary Files

```bash
rm -rf template-${SLUG}/
rm .template-generator-state.json
rm .tmp* 2>/dev/null || true
rm .js* 2>/dev/null || true
rm .py* 2>/dev/null || true
```

---

### 6. Show Final Success Message

**IMPORTANT: Follow the below example exactly**

```
âœ… Done! Your ${Template Name} template is ready!

ğŸ“‹ Template: ${Template Name}
ğŸ“ Description: ${description}

ğŸ“¦ Package contents:
   âœ“ metadata.json
   âœ“ entities/
     â€¢ lists: ${lists_count}
     â€¢ documents: ${documents_count}
     â€¢ files: ${files_count}
   âœ“ flows/
     â€¢ automations: ${automations_count}
     â€¢ chat-agents: ${agents_count}
   âœ“ claude-ws/
     â€¢ workspaces: ${workspaces_count}
   âœ“ IMPORT.md

ğŸ“Š Summary:
   ğŸ“‹ Lists: ${lists_count}
   ğŸ“„ Documents: ${documents_count}
   ğŸ“ Files: ${files_count}
   âš™ï¸ Automations: ${automations_count}
   ğŸ¤– Chat Agents: ${agents_count}
   ğŸ§  AI Workspaces: ${workspaces_count}

ğŸ“¥ Download your template:
ğŸ”— ${SLUG}-template.zip ${DOWNLOAD_URL}

ğŸ¯ What's next?
   1. Click the link above to download your template
   2. Extract the ZIP file
   3. Import into your system using IMPORT.md
   4. Start using your template!

ğŸš€ Ready to use!
```

---

### 7. Update State File (Final)

```bash
update_state 8 "PACKAGE" "dummy" 0
```

Then delete state file (already done in cleanup step).

---

## Return Control

**This is the final step.** No return to main orchestrator needed.

Process complete! ğŸ‰
