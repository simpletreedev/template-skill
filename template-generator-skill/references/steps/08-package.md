# Step: STEP 8 - PACKAGE & EXPORT

## Purpose

Finalize template, create ZIP package, and show success message.

---

## What To Do

### 1. Update metadata.json with Final Counts

```bash
SLUG=$(jq -r '.templateSlug' .template-generator-state.json)

# Get counts from state
LISTS=$(jq -r '.summary.lists' .template-generator-state.json)
DOCS=$(jq -r '.summary.documents' .template-generator-state.json)
FILES=$(jq -r '.summary.files' .template-generator-state.json)
AUTOS=$(jq -r '.summary.automations' .template-generator-state.json)
AGENTS=$(jq -r '.summary.chatAgents' .template-generator-state.json)
WS=$(jq -r '.summary.claudeWorkspaces' .template-generator-state.json)

jq --argjson lists ${LISTS} \
   --argjson docs ${DOCS} \
   --argjson files ${FILES} \
   --argjson autos ${AUTOS} \
   --argjson agents ${AGENTS} \
   --argjson ws ${WS} \
   '.exports = {
     "lists": $lists,
     "documents": $docs,
     "files": $files,
     "automations": $autos,
     "chatAgents": $agents,
     "claudeWorkspaces": $ws
   }' \
   template-${SLUG}/metadata.json > .tmp && mv .tmp template-${SLUG}/metadata.json
```

---

### 2. Create IMPORT.md

```bash
NAME=$(jq -r '.name' template-${SLUG}/metadata.json)
DESC=$(jq -r '.description' template-${SLUG}/metadata.json)

cat > template-${SLUG}/IMPORT.md << EOF
# ${NAME} - Import Instructions

## Overview

${DESC}

## What's Included

- ${LISTS} Lists
- ${DOCS} Documents
- ${FILES} Files
- ${AUTOS} Automations
- ${AGENTS} Chat Agents
- ${WS} AI Workspaces

## Import Steps

1. Extract this ZIP file
2. Use the import function in your app
3. Select this template folder
4. Confirm import

## Requirements

- Minimum app version: 1.0.0
- Required features: (list if any)

---

Generated by AI Template Generator
Version: 1.0.0
Created: $(date -u +%Y-%m-%d)
EOF
```

---

### 3. Create ZIP Package

```bash
cd template-${SLUG}/
zip -r ../${SLUG}-template.zip .
cd ..
```

---

### 4. Upload to Cloud Server

```bash
ZIP_FILE="${SLUG}-template.zip"

echo "ðŸ“¤ Uploading ${ZIP_FILE} to cloud server..."

# Upload to cloud server and get URL
UPLOAD_RESPONSE=$(curl -X POST \
  -F "file=@${ZIP_FILE}" \
  https://nfknprk0-8000.asse.devtunnels.ms/api/v1/triggers/upload)

# Extract URL from JSON response
DOWNLOAD_URL=$(echo ${UPLOAD_RESPONSE} | jq -r '.url')

if [[ "${DOWNLOAD_URL}" != "null" && -n "${DOWNLOAD_URL}" ]]; then
  echo "âœ… Upload successful!"
  echo "ðŸ“¦ Cloud URL: ${DOWNLOAD_URL}"
else
  echo "âŒ Upload failed. Response: ${UPLOAD_RESPONSE}"
  # Exit with error - don't continue
  echo ""
  echo "âŒ Error: Failed to upload template to server"
  echo ""
  echo "There was an error while creating the template export. Server response:"
  echo "${UPLOAD_RESPONSE}"
  echo ""
  echo "Would you like me to try again? (say 'retry' to attempt upload again)"
  exit 1
fi
```

**NOTE:** If user says "retry", go back to step 4 and attempt the upload again without recreating the ZIP file.

---

### 5. Clean Up Temporary Files

```bash
# Only remove template folder, keep ZIP file for local backup
rm -rf template-${SLUG}/
rm .template-generator-state.json

# If upload successful, you can optionally remove the local ZIP
# if [[ -n "${DOWNLOAD_URL}" ]]; then
#   rm ${ZIP_FILE}
# fi
```

---

### 6. Show Final Success Message

```
âœ… Done! Your ${Template Name} template is ready!

ðŸ“‹ Template: ${Template Name}
ðŸ“ Description: ${description}

ðŸ“¦ Package contents:
   âœ“ metadata.json
   âœ“ entities/
     â€¢ lists: ${lists_count}
     â€¢ documents: ${documents_count}
     â€¢ files: ${files_count}
   âœ“ flows/
     â€¢ automations: ${automations_count}
     â€¢ chat-agents: ${agents_count}
   âœ“ claude-ws/
     â€¢ workspaces: ${workspaces_count}
   âœ“ IMPORT.md

ðŸ“Š Summary:
   ðŸ“‹ Lists: ${lists_count}
   ðŸ“„ Documents: ${documents_count}
   ðŸ“ Files: ${files_count}
   âš™ï¸ Automations: ${automations_count}
   ðŸ¤– Chat Agents: ${agents_count}
   ðŸ§  AI Workspaces: ${workspaces_count}

ðŸ“¥ Download your template:
ðŸ”— ${SLUG}-template.zip ${DOWNLOAD_URL}

ðŸŽ¯ What's next?
   1. Click the link above to download your template
   2. Extract the ZIP file
   3. Import into your system using IMPORT.md
   4. Start using your template!

ðŸš€ Ready to use!
```

---

### 6. Update State File (Final)

```bash
jq '.currentStep = 8 | .steps["8_PACKAGE"].status = "completed" | .lastUpdated = "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"' \
  .template-generator-state.json > .tmp && mv .tmp .template-generator-state.json
```

Then delete state file (already done in cleanup step).

---

## Return Control

**This is the final step.** No return to main orchestrator needed.

Process complete! ðŸŽ‰
